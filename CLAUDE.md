# Scatterize — Claude Guide

Full rationale and design decisions: `docs/design.md`

## What This Is

Pure client-side scatter plot explorer: paste a CSV/Google Sheet URL → interactive scatter plot with regression, point censoring, nuisance residualization, URL-shareable state, SVG export. Replacing a Flask app; deploys to GitHub Pages.

## Tech Stack

- **Stats:** Custom implementations + `ml-matrix` (QR/LU). **No simple-statistics.**
- **Plotting:** D3.js v7 (not v3/v5 — API changed significantly)
- **CSV:** Papa Parse (`header: true, dynamicTyping: true, skipEmptyLines: true`)
- **State:** Native `URLSearchParams` + `hashchange`. **No jQuery.**
- **Build:** esbuild. **No CDNs** — all deps via npm. Dev: `--servedir=. --watch`. Prod: add `--minify`.
- **Style:** Quarto/R-docs aesthetic

## Coding Conventions

- ES modules throughout (`import`/`export`)
- Stats functions: pure, arrays in → result object out
- Consistent stats result shape: `{ slope, intercept, rSquared?, pValue, n, residuals?, ... }`
- OLS and Robust **must** return `residuals` array (used by diagnostic plots)
- D3 v7: use `d3.Delaunay.from()` not `d3.geom.voronoi()`

## HTML and CSS

- Use semantic HTML structure
- Don't put classes / ids on elements that don't need them. `<button class="btn">` is a trauma response imported from bootstrap; let's break the cycle
- Structure main page sections filled with related content with `<section>`
- CSS nesting is encouraged

## Statistical Methods

| Mode | Key | Key Output | Covariates |
|------|-----|-----------|-----------|
| OLS | `ols` | β, t, p, R² | Yes (residualized) |
| Robust | `robust` | β, t, p | Yes (residualized) |
| Spearman | `spearman` | ρ, p | No |
| Theil-Sen | `theilsen` | slope, τ, p | No |

Spearman/Theil-Sen don't support nuisance covariates (rank methods don't compose with residualization).

## URL State Schema

| Key | Value |
|-----|-------|
| `src` | CSV/Sheet URL |
| `x` | Column index (int) |
| `y` | Column index (int) |
| `m` | Model key (`ols`, `robust`, `spearman`, `theilsen`) |
| `n` | Nuisance column indices (comma-sep) |
| `c` | Censored row indices (comma-sep) |
| `h` | Group/highlight column index |
| `xl` | Custom X axis tick values (comma-sep) |
| `yl` | Custom Y axis tick values (comma-sep) |

## Project Structure

```
src/
├── main.js
├── state.js          # URL hash state
├── data.js           # CSV fetching + Papa Parse
├── stats/
│   ├── ols.js
│   ├── robust.js
│   ├── spearman.js
│   ├── theilsen.js
│   └── common.js     # residualization, shared utils
└── plot/
    ├── scatterplot.js
    └── dashboard.js
public/
├── index.html
└── css/style.css
tests/
├── fixtures/         # CSVs generated by R, read by both R and JS tests
├── r/
└── js/
```

## Testing

When adding a new stat: write R reference first (`tests/r/`), confirm output, implement JS, compare. Tolerance: ~6 sig figs for coefficients, ~4 for p-values.

R references: OLS=`lm()`, Robust=`MASS::rlm(psi=psi.bisquare)` (M-estimation, **not** MM), Spearman=`cor.test(method="spearman")`, Theil-Sen=`mblm::mblm()` + `cor.test(method="kendall")` for p-value.

## Key Behavioral Constraints

- **Censoring:** Exclude censored rows from fit. Axis limits from uncensored points only.
  - In-range censored: shown grey/hollow, clickable to uncensor
  - Out-of-range censored: **one** corner marker at nearest boundary corner (not one per axis)
- **Diagnostic plots:** OLS and Robust only. Two mini-plots in stats panel:
  1. Residuals histogram + normal curve + Shapiro-Wilk annotation + X-axis fringe
  2. Q-Q plot — theoretical quantiles on X, sample on Y (standard orientation, do not reorient)
  - Both update live on censoring; hover on main plot highlights both
- **Nuisance covariates:** Residualize Y first; axis label changes to "Residualized Y"
- **Voronoi targeting:** `d3.Delaunay.from()` for click/hover hit areas
- **Google Sheets URLs:** Transform to `/export?format=csv&gid={gid}` before fetching
- **Keyboard shortcuts:** `j`/`k`=Y var, `u`/`i`=X var, `o`/`p`=model, `c`=toggle censors
- **SVG export:** Must work in Illustrator (fonts embedded, no external deps)
- **Axis ticks:** Per-data-point tick marks; quartile labels by default, overridable with `xl`/`yl`
